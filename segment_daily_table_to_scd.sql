-- Below query could convert daily segment table to Slowly Changing Dimension table.
-- I converted apprx. 8 billion records to 46 million 

-- Daily Snapshot daily table  

customer_id       |segment|segment_ext1|seg_status|seg_date  |ddwh_date              |
------------------+-------+------------+----------+----------+-----------------------+
990809435745222721|C2     |12          |         0|2015-01-01|2015-04-17 09:38:56.575|
990809435745222721|C2     |12          |         0|2015-01-02|2015-04-17 09:39:58.821|
990809435745222721|C2     |12          |         0|2015-01-03|2015-04-17 09:41:05.778|
990809435745222721|C2     |12          |         0|2015-01-04|2015-04-17 09:42:18.825|
990809435745222721|C2     |12          |         0|2015-01-05|2015-04-17 09:42:49.633|
990809435745222721|C2     |12          |         0|2015-01-06|2015-04-17 09:43:06.619|
990809435745222721|C2     |12          |         0|2015-01-07|2015-04-17 09:43:22.793|
990809435745222721|C2     |12          |         0|2015-01-08|2015-04-17 09:43:38.941|
990809435745222721|C2     |12          |         0|2015-01-09|2015-04-17 09:43:54.810|
990809435745222721|C2     |12          |         0|2015-01-10|2015-04-17 09:44:11.907|
990809435745222721|C2     |12          |         0|2015-01-11|2015-04-17 09:44:28.639|
990809435745222721|C2     |12          |         0|2015-01-12|2015-04-17 09:44:45.782|
990809435745222721|C2     |12          |         0|2015-01-13|2015-04-17 09:45:03.571|

-- Final Slowly Changing table 


customer_id       |new_segment|eff_date  |end_date  |
------------------+-----------+----------+----------+
990809435745222721|C2         |2015-01-01|2015-03-14|
990809435745222721|E2         |2015-03-14|2015-04-07|
990809435745222721|C2         |2015-04-07|2015-04-08|
990809435745222721|E2         |2015-04-08|2015-08-06|
990809435745222721|C2         |2015-08-06|2015-09-19|
990809435745222721|C1         |2015-09-19|2015-12-01|
990809435745222721|B2         |2015-12-01|2016-02-29|
990809435745222721|C1         |2016-02-29|2016-03-06|
990809435745222721|B2         |2016-03-06|2016-06-04|
990809435745222721|C2         |2016-06-04|2019-09-07|
990809435745222721|C1         |2019-09-07|2019-09-16|
990809435745222721|B1         |2019-09-16|2019-09-29|
990809435745222721|A2         |2019-09-29|2019-10-05|
990809435745222721|A1         |2019-10-05|2019-12-07|
990809435745222721|A2         |2019-12-07|2020-01-06|
990809435745222721|A7         |2020-01-06|2020-02-01|
990809435745222721|A2         |2020-02-01|2020-02-02|
990809435745222721|A3         |2020-02-02|2020-02-03|
990809435745222721|A0         |2020-02-03|2020-04-18|
990809435745222721|A7         |2020-04-18|2020-06-13|
990809435745222721|A2         |2020-06-13|2020-06-17|
990809435745222721|A1         |2020-06-17|2020-07-26|
990809435745222721|A0         |2020-07-26|2020-08-16|
990809435745222721|A1         |2020-08-16|2020-08-31|
990809435745222721|A7         |2020-08-31|2020-09-01|
990809435745222721|A8         |2020-09-01|2020-09-13|
990809435745222721|A1         |2020-09-13|2020-10-27|
990809435745222721|A2         |2020-10-27|2020-12-09|
990809435745222721|A3         |2020-12-09|2020-12-14|
990809435745222721|A8         |2020-12-14|2020-12-27|
990809435745222721|A3         |2020-12-27|2021-02-04|
990809435745222721|A8         |2021-02-04|2021-02-08|
990809435745222721|B8         |2021-02-08|2021-02-27|
990809435745222721|B3         |2021-02-27|2021-03-05|
990809435745222721|B2         |2021-03-05|2021-03-08|
990809435745222721|B1         |2021-03-08|2021-04-06|
990809435745222721|B2         |2021-04-06|2021-04-13|
990809435745222721|B7         |2021-04-13|2021-04-17|
990809435745222721|B8         |2021-04-17|2021-04-26|
990809435745222721|B2         |2021-04-26|2021-05-27|
990809435745222721|B8         |2021-05-27|2021-06-04|
990809435745222721|B2         |2021-06-04|2021-06-05|
990809435745222721|B8         |2021-06-05|2021-06-07|
990809435745222721|B2         |2021-06-07|2021-07-01|
990809435745222721|B3         |2021-07-01|2021-07-02|
990809435745222721|B2         |2021-07-02|2021-07-27|
990809435745222721|C2         |2021-07-27|2021-07-29|
990809435745222721|C3         |2021-07-29|2021-08-03|
990809435745222721|C2         |2021-08-03|2021-08-04|
990809435745222721|C3         |2021-08-04|2021-08-05|
990809435745222721|C2         |2021-08-05|2021-08-10|
990809435745222721|C1         |2021-08-10|2021-08-15|
990809435745222721|B2         |2021-08-15|2021-08-21|
990809435745222721|B1         |2021-08-21|2021-09-21|
990809435745222721|B2         |2021-09-21|2021-10-04|
990809435745222721|B7         |2021-10-04|2021-10-08|
990809435745222721|B2         |2021-10-08|2021-11-23|
990809435745222721|B3         |2021-11-23|2021-12-27|
990809435745222721|B7         |2021-12-27|2022-01-23|
990809435745222721|C7         |2022-01-23|          |






-- Query to convert SCD
-- Elapsed creating table 27 minutes in Sybase IQ Database 

	select 
	t1.customer_id , 
	t1.segment as new_segment,
	t1.seg_date as eff_date,
	LEAD( seg_date , 1 ) OVER (partition by customer_id order by seg_date) as end_date  
	from 
	(
		select 
		customer_id ,
		segment ,
		seg_date ,
		coalesce(LAG( segment , 1 ) OVER (partition by customer_id order by seg_date) , 'XX') as prev_segment, /* NULL Converted to XX because of first record of segment */
		min(seg_date) over(partition by customer_id) as min_seg_date
		from customer_daily_segment_history
		where customer_id = 990809435745222721  
	) t1 
	where segment <> prev_segment 
	ORDER BY SEG_DATE  
